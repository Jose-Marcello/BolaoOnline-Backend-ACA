// Localiza√ß√£o: ApostasApp.Core.Application.Services.Usuarios/UsuarioService.cs

// Usings necess√°rios
using ApostasApp.Core.Application.DTOs.Apostadores;
using ApostasApp.Core.Application.DTOs.Financeiro;
using ApostasApp.Core.Application.DTOs.Usuarios;
using ApostasApp.Core.Application.Models; // Para ApiResponse
using ApostasApp.Core.Application.Services.Interfaces.Apostadores;
using ApostasApp.Core.Application.Services.Interfaces.Usuarios;
using ApostasApp.Core.Application.Utils;
using ApostasApp.Core.Domain.Interfaces;
using ApostasApp.Core.Domain.Interfaces.Apostadores;
using ApostasApp.Core.Domain.Interfaces.Identity;
using ApostasApp.Core.Domain.Interfaces.Notificacoes;
using ApostasApp.Core.Domain.Models.Apostadores;
using ApostasApp.Core.Domain.Models.Financeiro;
using ApostasApp.Core.Domain.Models.Identity; // MUITO IMPORTANTE: ESTE USING DEVE ESTAR AQUI!
using ApostasApp.Core.Domain.Models.Notificacoes; // Para Notificacao (classe de dom√≠nio)
using ApostasApp.Core.Domain.Models.Usuarios; // Para a classe Usuario
using AutoMapper;
using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Identity;
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore.Query;
using Microsoft.Extensions.Configuration;
using Microsoft.Extensions.Logging;
using Microsoft.IdentityModel.Tokens;
using System;
using System.Collections.Generic;
using System.IdentityModel.Tokens.Jwt;
using System.Linq;
using System.Security.Claims;
using System.Text;
using System.Threading.Tasks;
using Microsoft.AspNetCore.WebUtilities;
using System.Text;

namespace ApostasApp.Core.Application.Services.Usuarios
{
    public class UsuarioService : BaseService, IUsuarioService
    {
        private readonly IIdentityService _identityService;
        private readonly IApostadorRepository _apostadorRepository;
        private readonly IApostadorService _apostadorService;
        private readonly UserManager<Usuario> _userManager;
        private readonly ILogger<UsuarioService> _logger;
        private readonly IConfiguration _configuration;
        private readonly IMapper _mapper;

        public UsuarioService(IIdentityService identityService,
                                     IApostadorRepository apostadorRepository,
                                     IApostadorService apostadorService,
                                     INotificador notificador,
                                     IUnitOfWork uow,
                                     UserManager<Usuario> userManager,
                                     ILogger<UsuarioService> logger,
                                     IConfiguration configuration,
                                     IMapper mapper)
            : base(notificador, uow)
        {
            _identityService = identityService;
            _apostadorRepository = apostadorRepository;
            _apostadorService = apostadorService;
            _userManager = userManager;
            _logger = logger;
            _configuration = configuration;
            _mapper = mapper;
        }

        // Localiza√ß√£o: ApostasApp.Core.Application.Services.Usuarios/UsuarioService.cs

        // Localiza√ß√£o: ApostasApp.Core.Application.Services.Usuarios/UsuarioService.cs

        // Localiza√ß√£o: ApostasApp.Core.Application.Services.Usuarios/UsuarioService.cs

        public async Task<ApiResponse<LoginResponseDto>> LoginAsync(LoginRequestDto request)
        {
            var apiResponse = new ApiResponse<LoginResponseDto> { Notifications = new List<NotificationDto>() };
            var responseData = new LoginResponseDto { LoginSucesso = false };

            _logger.LogInformation("Iniciando LoginAsync no UsuarioService.");

            try
            {
                // PASSO 1: Busca o usu√°rio pelo e-mail.
                var user = await _identityService.GetUserByEmailAsync(request.Email);

                // Se o usu√°rio n√£o for encontrado, falha o login com mensagem gen√©rica.
                if (user == null)
                {
                    Notificar("Erro", "Usu√°rio ou senha inv√°lidos.");
                    apiResponse.Success = false;
                    apiResponse.Notifications.AddRange(ObterNotificacoesParaResposta());
                    apiResponse.Data = responseData;
                    return apiResponse;
                }

                // PASSO 2: VERIFICA√á√ÉO CRUCIAL - Checa se o e-mail est√° confirmado.
                if (_userManager.Options.SignIn.RequireConfirmedAccount && !user.EmailConfirmed)
                {
                    Notificar("Erro", "Sua conta ainda n√£o foi confirmada. Por favor, verifique sua caixa de entrada.");
                    apiResponse.Success = false;
                    apiResponse.Notifications.AddRange(ObterNotificacoesParaResposta());
                    apiResponse.Data = responseData;
                    return apiResponse;
                }

                // PASSO 3: Tenta fazer o login com a senha.
                // A sua l√≥gica original que eu removi est√° certa, vamos us√°-la.
                var loginResult = await _identityService.LoginAsync(request.Email, request.Password, request.IsPersistent);

                if (loginResult.Success)
                {
                    // Login bem-sucedido.
                    responseData.LoginSucesso = true;
                    responseData.Token = loginResult.Token;
                    responseData.RefreshToken = loginResult.RefreshToken;
                    responseData.Expiration = loginResult.Expiration;
                    responseData.Apelido = user.Apelido;
                    responseData.Email = user.Email;
                    responseData.UserId = user.Id;

                    user.LastLoginDate = DateTime.Now;
                    await _userManager.UpdateAsync(user);

                    Notificar("Sucesso", "Login realizado com sucesso.");
                    apiResponse.Success = true;
                    apiResponse.Data = responseData;
                }
                else
                {
                    // O login falhou por outros motivos.
                    if (loginResult.Notifications != null && loginResult.Notifications.Any())
                    {
                        apiResponse.Notifications.AddRange(loginResult.Notifications
                            .Select(n => new NotificationDto { Codigo = n.Codigo, Tipo = n.Tipo, Mensagem = n.Mensagem, NomeCampo = n.NomeCampo }));
                    }
                    else
                    {
                        Notificar("Erro", "Usu√°rio ou senha inv√°lidos.");
                    }

                    apiResponse.Success = false;
                    apiResponse.Data = responseData;
                }
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, $"EXCE√á√ÉO NO LOGIN (LoginAsync Service): {ex.Message}");
                Notificar("Erro", "Ocorreu um erro inesperado durante o login. Por favor, tente novamente mais tarde.");
                apiResponse.Success = false;
                apiResponse.Data = responseData;
            }

            apiResponse.Notifications.AddRange(ObterNotificacoesParaResposta());
            return apiResponse;
        }

        public async Task<ApiResponse<RegisterResponse>> RegisterAsync(RegisterRequestDto request)
        {
            var apiResponse = new ApiResponse<RegisterResponse>();
            try
            {
                var registrationSuccess = await RegistrarNovoUsuario(request);
                //var registrationSuccess = await RegistrarNovoUsuario(
                //    request.Email, request.Password, request.Apelido, request.Cpf, 
                //    request.Celular, request.Scheme, request.Host, request.NomeCompleto);

                if (registrationSuccess)
                {
                    var user = await _identityService.GetUserByEmailAsync(request.Email);
                    if (user != null)
                    {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    {ÁüÿHÀ:ïÊØcÃ6nã€:ÆÈ÷˛˚èF$x´◊jkXc'Ú∑sg_pk´∂Æ±<&ù¡Â"{†¶ﬁ°òÛjœö:Èö´zıR^P˛πAy√cÙ€„	AßaÉâ7›/Vy•¢LÂí^Xo©jêô åÿ!N√ÑAóÔN9*ÉA˘ñáO≤ÃÛæ8–úd9!Ö"ƒB^πΩoöÍÒZ¥∂¯"Ìi x‚õ\∆¡¶±w*ÀÇH%H'‚¬'0Ñ˚—√>±ß…ãÑO∂Ä‡u7å´e]å∂∫®¶ï –¸\˘uBr·21‡)Ûî¿	NydÄà[4ØS»rrÑÎ◊1 ÖW{íJîîê6˛{Æ~ﬁo†$  íÖ¬˝æÜ9"û*4√e†•ì¬r2Ω¨‚M$'hh™JïXµÕÒ¥–ÖgVijT6ƒç>ƒAÄÔ}Œ9€é)W™∏ﬁØ.Z“K#/î˘]G¯êÏvO¸<Á-ÊYæ‡˚óf≤N&´\5•w¸˜&◊¥ıCB∑x‚∂CÒ>8}ã)‡cPª˝Å76µ•6)àQcçÑod›,Ò∂SÈ≈§zÈ[W:4õ°Å¯ºT©3Eå~˚⁄ÓönBöl"â¬π4^*/ßéKÃ	'![Ü«Lú“∞˚ïÎΩ bÜ)Smº∆≥%¥›lráK!u"≈Aä?=u^ı|]UÎ5),óRDH@]1 r[Õó€GÊ÷À‚F%=2jR˙._µÕâ®ú[Z!∆d.N:}DWQFRÖQF„ŒI˙i≤dn*ΩêÈ)†KT1ÿ>$∏.pHê¨öÆ‹|‘I‚dHçc>Wâ”8 ôëPBH  §•v¸M@≈›Ò¸£˙Gwì¸~ıÖˆÎÃjÚ¿2»b∏+PÃ∞HY∞.≠—Tò¢TV‚≤®*	;e1
s‚u6ÍJêµ\ÑD ÕkT*tÔå˜}ë"j>OÕ˛æÆ¡òvV¸ÖYO˝ä\SpÛ,ß“p“«_û¡ê÷€9ñ@ J•¬ì}ÌÉ.ÿ≠{ı…†Â;ù:wÖ˚Md±3~®!Æ.™[‚kqê‘Uá"ˇ‰˙˜ˆyøõ©¥I~¥4WO˚ÌQ”{üq¯fmB0FŸÿ•Dã}!ç.√A–≈/Œu≈s∑óó!$Hã∫≈…iB$áê‡f˘Fk»6È,äŸÜ&¨¢ó;J©5PM~q„¢ <y õSRê2ﬂØ>„çfoæÚ_í{§TWñBRQ´L∆P.
ã≥fZN.≈RsóLßﬁ∂ÅqÈ√xÍƒﬁÜpjñ G#pwÒÂvs£Ä0Br€õ6ò
´√{EoAÙÆã…÷*o‹îõ•
”(EπÅf†ê«€÷“¶œÉöFê)tÍìQFïEC:’cP∞ñ¥“†®@	Áùq;¶≠yj’f§" 2Y˝&¬ÁΩQ££¶ÔÁ˚[íq>2Ã~27_zÁXûSól5</j˛*[vyÃ6pqÑbd^Æ+&”Qöˇ'CMß£≥&˛Œxì#®*°¥n–bõñÇg∑«å!§Ù)k{9≤†e‘ü+b⁄ì¬ËWì√;€(R∑!Ö>√Ha `H1CÙ≠u⁄¸jUÆC%›%iëRÂ∞®D4"<ÈÔÑ´[2D5=Ïuc≠Ï8¬SÜ›‡E≥∏ˇ4˝≈ HVì˙ˇÓÛ˚ö˛7ı\å–oå7ê±wou'ÖÖà*c éÆÇ»∂}=π˘é£∑ˇœWØpãfioàºP,X¿©ËÌ*<tíèß5sé¶è⁄Êçeà¿ t;?.¨*AÉ±¿˚À?ˇ◊ÔD¸?ˇ~1NñØßëπ√ˇ.};åaÎ‘ŒEö∂œ°¢ì?6Êê≠Êåú~ø“"ÄÃ"!Q1MÉ± ,àŒn3[‘LïiQ•‘`D˘*;ó≠˜˛
.›˙n_ºÙòˇUù„æûWMÉeg~qøê∫Å7"úÇÇt^('TáÃdv≈Â?•ÁÑ-Èâ"Å!p∫I~4Iï/eÌZ≠˜Hiç–'e≠ìwÁ0®R> íî¸!Â¢ïeb@ÿbw∑u;£Dïó©Rdë+Uç÷ .0€Ö≠FëÍiÎ»ûEÁ46uJ(©!ÉŸ·éo∫æy	ÆábØÒ˜´≤©_ÌôÂ∫sg˚Ï/‰Ú]“ˇˆ?6r∫åC[€GCÚr⁄öUz}/úúÃ+≠4ÖÒÒÇ®Ïá√Çf¯\[¬íí[πëŒ‰õÍ—ï*V`"4Éu∞àˆ(/⁄∆%≥‚∆i"Ì„Ão·‡WﬁGg∑øç±X∫l⁄é⁄ªJî´5*ô˜€_Sedî õbÈ&∆IM(ä’äEeƒ®ì∂XcQlL»ÉUH°a'oiT	™c⁄jª÷d™πS{æ2Xª`à] i£}o†ù™j⁄Ãûœq≥YÌ%¬-=ÑÚ€û’L§g%Ø1~ß ˝•ˇ|Ú5 Zóæ*”cè¶Â§%“smKé%Ï!ÿ¨ÑbäsªÓu∆d≠€52µ´ºU…≈∆HÌˆ~+ç⁄»Úâ¯ÏóïÂô∏˜ìf’76àÜY•|-RÊÜΩ’7ô«òÛ3\ù"»j1aòÊÓóR◊‘›òv*®…Q”∂ézÎ◊É„¶•LYz√—U”ÍA¨‰î+\9¥ˆ∏Ë™¶„JﬁêÚ≈ƒtkHj´˜I;}WQÌÍªÈ—5OŸØÎr≠@Î|◊!”u≈}∂ΩÏÑ&¬‚”§z§õd¡$Ì˛â¢)p¬%s¬ä–4—p5o~9◊ø^s7œÉçA<Ú§Ïœ8≥h≈ØNÊ`¿”ëVn–UVÿè!CÇ]E√…öâ{Ï¡{T ºU¸÷ˇïÔ´ºπiî"Ú!Â¶ú¡!0‡Fñ€Ûﬂ◊Z™VÓU…ªöï2Í>¨¨ hfW)hπÍb-+≤ ≥oO4GNºø4ò <'¨4õ£VÎÉ÷]˚;b;OZ)÷kƒQ›Õn≈uÕﬂΩRÌ§IªQPeÊ.c$çÇ∆ˆßÉœGHX¨nA¯†·=ﬁÏ:—rÿ∂ü|YWäîª √⁄Ì\≤Ô≤z$Î≤5≈+≥8N’°•c£ù'®$ﬁ„%≠ãjn¥%\çIê.∑•KÏ˘≠z√≥ç$ ì®Y ]àXÖ‹ﬂ⁄∂Õz∞î`*sÑÕ14]ﬁkﬂä∂ß5RZ°?ëÙ˝kxÎ5H¿ó\ÕüÌvc°W¨¢á,@v£[Õ^<	ì∫ú™ ”ÑgÇq:ﬁ–—∑8!›Æòbc ÑÍnwÆ&ÌWÃµj2N
Dª“L `f~&}Ω¨ºÄ‡æÎMØwR[)≤]‡Zâ`úr∏ùQAÀ¢Ü€Ï9ÔÜé“ﬁG#8¶u'CŒ∏Ù6Ye•W@ 9¶“àDUâ»ÑøM¡U…‹˘L"Ì2†æ˜ˇÉõ¥$±ä1X0F,Á^˘Ÿu„=9I¬µä;kå	^¯äR^ªøŸ¸Z{∂~OŸˆ˝˚Ú¯W√?ˇVä5Î{Ú!£Öó„GIﬂyªîI∞"®ƒ&åàKÉE ~ˇè∑ú•Õ¿	Õ8X∑ªŒ¸À&ÁΩìàK◊˛¢ ﬁµéçüË}`óÎ©∂;Sg/‘2™3üXrÜ8˚ ÈﬂﬂòÄ/çt1•∂Oq È!Ω%âJc@Pbw;ñ´ﬂ>ÿ’U ∏…4*#N≤Ë yú/í'4˜.ÿß‘µ©K.CE§“ŸÜó≠∞oM„PëÕ∏”÷kg-l2¶∆∫ö£Ç€ôb¥ëA	î*	—BƒÊF‹çC\üA"∫”·](£ Ç‚BÏ÷≠œTHtŸ·`43˘$¶èæà™πÖà⁄abÆ[dóA™∂«OsZ)X”èDœz~†íøäkÏ∂%qègE9ò”‚ª_—M‚‰ ˝5ﬁå¨	ó†äâjràE;≠UU^]”u5ù3û8å˜œâﬂwæã[C™˚√◊[◊)1X»mg"z6wïÿﬂçÂ°Ö$æÿeá"FüúÚŒ˘Kπ4∞4¶_3û;tÆ∞!l%óBc†Ö/”◊∆•{Î8©©{’‘´ë]PÔØ≤ÄÎÆ≤º>îí%A˝îRGgã∞ì$®˘eú◊?k“íUáu7W%|zº‘xfrPT_g¶çÇi	VmßìuGŸ“Ãπ⁄U€≈FÚÄ0*hIåÆ2Ö&d≤[í\ ÅPâÇ£rß2EŒÈ÷KaÔ9
îÓ_IEŸUßòG∂≠áÓf'DãGÎx ∫FÅRZ8®¢3ø≥ÌFò¢F”KÉ†ƒ`wø|q+«SÇIRDâQ® ıóˆ.Õ :bqÖm|££˝3<y√≥áÓ/Ç·¥çÀ‚.Yıü>˝≠mt^{MÓœ^€˚RôI‹~G7`bv’]“ŸÂpp` c~£J[VôGíU≈°â)√3O≤Àô+VRR+KBc∑$q‚‰æ§†ìsÜ±¯p*∆òF1à'Ø‘⁄|å/€Ë%E∫mGNKÚπﬂ»¥¬Á+
UQœ!ç-ìJaÛ§ÔõÛØô¨’Ií“BD"†"°Éåí¨1◊ˆ_ñ≤¿∫C™Ñ/ñ¯¯lÁ(™ªBÅìX' á3°m*3\Ï{¶0	:π3q[6ä¬VÁÜ+slÏÛÂHQ”ª6C±Ó∂ÒúX.û¸Øˆˇ–◊N-…Ù:sì´A⁄nQÆ∞~cœ=˝ˇW[H†¡ÜyßﬁmñO(˛gÌ:´˘ˇ◊“,=ÉÂû∑'µÂk«Øˆ<xå'1ç —Éœ«««†ñH†≤›ñSƒ@Yû}3ÃA7@Ëˇ=∏R\çˇO…Í˘ÓEu„”¯˙=ú KSYh! )úﬁ≥ú≠kn*…ó$®H"1†ˆN…ƒc∫}?pÃçnŸ]6˝ròSÍìÿ-f"ZU4f’@Wπ:!oá¥´©¨S™7#!UpB‡≤é&ƒ»9ﬁÀlN°=—[-s!˘YìÎ‘∂ìÉKÈ	´)÷ MP!’)è¢0≈s≈Ô)ä§™"Ø$íD+A∆}Jı´˝Ïìœ€j´	A©j¨üuØ8¸Qn¡5j∞`™
JåH≠6wó·úuÇª~}—∆»`è ‘kß%=‰I~≠è≈ &hqı!Ÿ∆WR¨Nf≤Ÿ Fu◊g∫fCE«Lí3‘Â$˜+}¢óB3ôaÚäÊï9SÄw≈*©aKÇÂ∂åz∞JÄi z±A%G*5ÂFY‹≤Ç’ ÜıÑ€•fkƒ|mˆ$ü—˙òÓ$!x 4”PE[„[Ó¶•nÚ•(Ç≠{g¡úØ∫Òr\A◊6Û8F¥B±†J‘eÓ)y_‚◊¿æÛV◊ç÷¨ 	>!∞î∆Ü∞çxäı©Uó7≠…RU-$Í¬Õqœ÷ØU÷:íY¯Á≥J@J]$±ÿ¸÷~Y‰4€|mü∆k‡Ä‘Ng–”/ŸˆfaeãÚõrTa^M§çhÖ≤”Ã°zÑÌ-Ë•XN†™öó'ëÂ˚=xı$Mpÿ≥≈◊˙PÓVÃ8Ë˜5M∂&™ç÷5Ví~ßU:wﬁ¬ïK◊[*/‘¸ËºO±9$Gºà«≤∂QI≈¿ôíw”J5<fKÊ≤`!û¬x≈@≠§Ìª∑ß›ì÷ñ´,Ê◊a·íQ—õS‰ÄiÄ ò¶±¡oZû9ΩL´.,;ükUœ:‹≥).2álå^˛Ωz∫“¬%á†Ìà	>,€DŸ_u‡CÑ)∏Zú!û%AÇ!ÀÀ‚õÛª©*Í¢Æ*ó"óv 
æ_$Hø«Â?§L«.)[µ∞◊∂∆∑9A¥mü+≠Öfz\ı⁄ús‚§ëiŸ’ˆW∏…,7‹ã#å˘ôÉ´Â´¬¡|·ìILπê‡<:Û§Õdrí§–Êu∞åç±M€Pó<! Ø$–˘ÌtÕ≈WSÒRUoåÕ(®^Ç£¡¬∂ç*2÷˚ 5‰ÀSp3ô∞¢Àüß|ƒb‘v5béÖá+ÕVUùXRÜﬂ ¢‰C3ï P_äp^¿' 4÷2 ›¥ÁRÍãoUœÉ˜îFFrÛ…©ÍøΩ˝'^‹6áΩ˝È˛bÖ#0ÃjÈLK@ë@U À!J¬"®'»ÑNUÏq¥©ÿë7÷óõÂÇΩ!≈¢&√Pä^ﬂòÂÁr ã$™‘TEËPH0âòŸ~WzΩ‚Áf¡b∂À¬;Ôô≤ÍV6ﬁﬂ*ßΩÑF- :ù7πáãm8À8\ãÜ%TNä\ùl◊úp≠RüZW‡ú–FAVMà+pV¶•G‹ÏláÃ*sJMê›R*ã#@ì’k;guèD∞•5ëP0¥V›≤ÂY_ü®ÌõÑ¸äæªˆ≈FfÍ ™õ?ol5ﬁ*aàî˚|∑Y4P¨¬(•4B≤ú^kä;M!∆ÖÇƒ.ùÎœ:ï∆TóúÙ-ÖˇÊ Ó/‰á!dyªk–µRúy÷◊.ö9rÎNË›%4€ñò—ÅúØM~â¶ØS¶#¿Í(Ω˙;∫ØO¬åµìÓ˜ I‚(ﬂ…˝∫8OYßw5;…6 ]!-;!ï" áΩÁôø<r–’gë§-(Díã‡≥6(J‹∑˚GF≠k˜O.	nhñÒ‚™Û
E…g% A ˙‹p-ù$hπI"0L¥\ŒøBòàÄ∂Çk
Å3-$◊4£ñÂA = 
7õãÅÅEœzçÛ˛√èÜ:˚µ6ÍUò@w”:
H®ŸSV™qI¨]Æ·e›UË≠Bù¬≈íàôUªÑPàKZ)¨bêÃŒ∂ïz…,ì.$"µ4 ‹è‡ªˇôsF/ÑW›¢xßf}˙£ÿuKûê•ΩwK÷]óÀ1Ûã∫Éq◊ü/„)„§Ò5≈Iäxæ{p§∆6√Fê Õóq†õÆ•äˇ"›–≥*'ö¡≤Ì‹ÔØ∑:w˘iß”gÄ›	/«z£¿IÉ>t?ì:fbì*}$6∫ )`5˛,‚B‰ *ò≠…è!}!ôa†¿*!SÌª„/}ımÒu%fÆÀâ.E∞Ω‘Åµ9bÂf=ß≠πw—±˘x*ÿ”wòP£IcﬂóN“[\áøºÈg0$ Ç≥±ú©Ë)ﬂÇNú/ì≥a]^u•¢íI,IÄÜö 	£éjÄZÙn5€!∂&„Økh™gÉnÙÊp+B»ó}ÑÜ±E—ÕÁ⁄6ì≥™¡~UCW*ØE¬J◊Mb	@ÔzÆ#ñ¥ÕD*ZIPNçCªz¢…‘‹”ªOfÜ´.£uBû}ûÂ¿?Áö]æ>±°™≈G˘}ø(^Qm=2…¸Ω€·´+∫ V:ê≤]$Õ?ãƒ@ûÜïM‘(ˆBª2Â∫‰éÕØ%%:Ω‘”öAuA ócÀÃ!”	
 ŒËDﬁP¶ÚKÎÃJfÇkµŒÊ7[ˇíé]ÎìVË¶µl∞ïDnàˇ!∏î«ß0êb7wnn§¨≤&] ∏í¢!R‘∏s~∑Ÿ˙ß(≈⁄*vπ6s+bÏÍóØ©*Î 2é&†•¶ÏyCŒT‹≠¢âJﬂîi¡n$óÕÄnX#%[+´‰'k’ïPo _ƒ hûùeÅù °Çsß≠≥æP°DA(ÆRHb8Á¢^gÀÆH‹ÕïÃh¡Ê4Åñ˜WLΩ6ÿˆëÌ}Aúc0êæœ˘«Ë6¬FêÓØ	ùË¯
ØÉ“ÎRN°;êM>úõldBŸ◊Me‹¥Poù<∂*åR_“‹åaI,ªøß‚^G{il<=aÁ‘`rèè]OãlÙ3,∞±ú&i¨tC≥.Ã››$©+&¢^\:ÊQs˜ûÙ\7€¡yÜ≥öã∂#ï€#`‘£0±Ÿ∂—B+ìR—5≤»”m´Lmgﬂç}˝ÚIm‘H5¸£Ì±&ŸhÈe7πtm'Gú„ngÛm…}˜íuƒd»ü&·`¯!Ÿ
Õf¿X(!;∆≤‚¶™´VÀ¢ƒ´§ÇK∫„:Kè˛øcÇ-}Ï¸∆vúø.Ü^œgs∑/2b[J°?)®ú≈û\é≤ õ√vÎ∂Z"AR4ØfÆ}ˆPÅ∫.ôπcZ÷±'µklB∞	à*o∫ø≤îìWe˚ÕOõ-OQ• z0võ^Ωw“…6(∑«ì{˝¸6UE‘ÍqYk*H£≤jt#ΩH‚Êé‡øÒY:Ú’uºAKdAQó îy?ân∏zyøpjö»AàÅŒon7®ì.RJÀWÎΩn{Ä¨0g≥tå˜:ÿ3i‚	∆V®ÕÀà•œòÄÎ∆$∫‘öé†Å –√”}¸˙⁄ÜLˇCm£±µ=∏X8ïyÃ7ñ )∫_yo!Õ≠ëc@ÖOyæ§«dH©uu%EH‚H∞aà9€»ø|À»=ﬁ¬~®GC2>„bS¸Ÿ`(:™”Ó¸¡µâfWìÿêtâÂÏæ≥“XÍl Cx”∫EíSGº–Eƒåàtqbaøù;≥¸ÕÑÆYX É∂Ñ»qiÎ◊@’!ƒ¶π§˜◊œØÀ]ˆ˙Ú√DÂ˙Th∆y"»fÖ∫s€ß=¯iœo√π‡µHƒ@≠9Ûñ…ÇÇ1°ö&Y°HÄu√·R≈"ä†&jF!å"xõ‡´ï®∫%W[ˇpE∫ˇã©©º?m°¯|3Ñ4:Åaf®ó}#‘˘‡¿a"Çï¨f∂è∆qäﬂ ª‡yÜqÙ!
òÀÃ≤ö˚mk°Ó≠ı°•òÄé3{Otö’üô“"
3Æ!≈≠ç@¿ô"ßª><i«n≥¨≠$àºï$ªµgœÒ\zdëDÇıÈŒ-F Tùv—≈¢æ;ıÚó•÷ajWN–«ïf»ÅAõ¶èß—Œp €o”‚jtÛSFîe DKPW.j’√f)3S6pmjmî‰<¨SEô¢s†YM’m¨±i)∆{È«v¬L”ÌÔóªWìfæ]⁄Ω;
ä]+´Ûö1Zî≈Z¶Yì¯`ï≤Ån`´ÇÚ k∑´¥oBÖ…éÄL‘`lS,BÌœöõÈÔ˜jì/sQKœ¸ƒ@!ËïÁWVÀwºlö}Ødc7≥éDÁùΩÊ7„†§FvÇÊ¿ÆSDÊI!1Üë]=‚`ËRÖ√{a÷˝ﬁ#y“∂%˜4ê3Èƒ -c!Ñ ≈w¬˙_ˇ/˝Æ÷ßPí ¥√!Ω≠çCe
ü3ü©ﬁ•ÛIMnIówdÄt
ºê∂ñ%.0O^]8´åòf˜&~§-8ù';“R[Ñ∏ %,9]hñq09“ßõ6)ÔV·„fC®ã°—ú%˝Àü7±d°ÿf¶V≤ôçÆ
ëù/ãπOjYa»íl⁄_6Â≥ ô◊F~XyƒçÅ“–∂`Ür•@E¯*Îı´o†‘>—“¥$Ã	;î'2">≈ÿ¬Vú•E]Ic	ätàÇƒ/S~”ôwŒùe÷^K±óˇêäcßﬁòFU7F}kê˜ÿˇö1zç∑aqëƒ- ‹[†*|`æ/[ªÁ∞»Iã—_N¥¥0
&`âÏ?ímD¶ˇå;gû9d’‹‘m∂IgÁ\∏‚aÚ“Ñù•¡wsÕ;lΩ†±b„!≈öå≈Ç≤O[À’Ê≤‰≠b…	xö∏K†-m5B€›≥ä“≥®6¯BsWâY/T“û÷Ë–sŒ?mÆ6‚Ö\úıO&B
£R†Ç∆`ª‹LFSÈ_£˙öMU ÓÖ§¸÷k◊:gS†]»íØ9xê "=@{º∏·ö«üÀ◊nøØó˛—∑úæ]D≠T
CK◊„ß≠€∑ª;"√[RvŒCŸ%ü|Ì£ÓŒ	ivs-ÿWüA!;Rx.í6ÿD˙|T∞F]≈¡b∞	jãπØ*∏$íÍâZLˇ‹$‹8ˇY¡r*Æëj{Ÿ¯◊:Û{˛áaôÖ®‹4Lkƒ%B≠ïä∆ƒ¥… kÄtŒ»¸0ßÇ.¥!oº∏kÚ◊ÖQ_Qâ‡)DSh5ë•∫`˚‘∑@ﬁœàÔ– ì“$‘Ï:TYÅÿ!Õ±çDa¡Õw◊çg[‚I2@íLñì8ƒp dG≠p,Õ÷8Áπ}ıÂ>Pù@»^⁄^áÿ˜gÉ1ı_√˝˘iØŒæ…?›±í#28–«´mBªÒl`Uê$÷h’\LÑ˜’Ui±äó,˛”iIíW>.
3√…}“‚’k<@Ü¢oÅŸvûÅ{M¡ÿ»®gQàö‚!Ç ï ‡ç4ÔÜÅd›rp%µÏõã“©òˇCfsqÎ˚?/gv]ñ%á#ôΩë‡oE2â}CH	Iæël¥€:mƒ :·Ò–Ç»[è¥∫O3gÇ† J¥gmbö»B’úÎÁ©wSPä3WB"∞]øπ”»RÛ¢¡z”·VW∫våL ÿVû zÓù[,ÕíW”¬©HªÉΩª#~?[§í-‡2°Yª˝e‘æõ˜π9∫S)y!µ∂ba@òT
à f˚ÎöÁé7}D^EZÚ]RñönJ~∑6∂ô;Oo‰¬«^<2ﬂÎ•@MæØ£„ÿØ¢≈°°Ω◊L:z±Ø∑2Í Mp¨x"œã©≤Ôùø¨){6Å©ßµÔ¥M∏ñ{<%Æ⁄Ç-ªÚYß≈nHÉ< e41»ñ•)4˙4´¢N∫¯q1´Ù3)wÑj¥]˙)ÔÈ4€üBë(eŒ`˝§d‘√/\á€f¬∏÷[g?‹ŒYE`
÷˙›|"ÃMÔ/î¯vŒÍfQÄ _-ŒÏÄ0◊¢È√<H®ñ§B§=‹Á≠Ê˜Ò‹ˆµõ∫ﬁµb!Ì˛µÀÛ-¡ë…HÂ]™Ú¬»#Wmê,,¢¡ãÍã:^KKÚpF,˛@mc€U\Î£•ÏJÆc~Â<-ê$i29ÑMgÊÎUVØbC!%∂BaA‘"wÎÔƒÀÒøl_WV§À∏ÀJÑ—p (Ò`„oÓåhfÆŸﬁ¡~ˆ˜√Nöï˙:èJÂÂz˜S5/P##Qxìù9g¶eÊíﬂ‹ä9?Å‰˜û ¢¶.ÌÒi≈è˝OÌıÿú∏É@ã“£}BQ4E0
@P‘ÕÀ’∏Z≠˙îtçcŒ¸z¢®ä4 t 2Ç%ΩµW¬}L◊… åØŒ*Â¿:∞Õè™1qw/‡ΩûïÍ∏ß 0ÿ"ÎàRB…EˆSù«Ÿ¸∑ﬁˆÃS@ pOØ÷ú îe6›≥
ƒ;zÅp‘ÜR	Ç!AÉÑ-Ì™Æ˘ˆÂ~—uªø]qı⁄x?Üﬂóymcu}~®büΩ∫
Ì‹∞õ|só≤íévÒ”ú<ô™%WôpC7zË+íË`ÄºÔWp‚‚TD!≈πáFQ¿X¬v˛}¥ŒÛÕÃ‘∫∫Lπ%B"¢@0¢È≤¬% Æ{∞}[}¶ÉK≠◊¥ÒC6ì©Ëú†¿´LÌ4hPÃS-9S8ÑÖ3ëÂç,!Å\ÑZ‡mç∏â2&Ã¡BÁ>6ﬂS∞Ÿ£›9pO◊úÎt∂kUt]/’;#oG∫oU@1.ÈÕç¶;<∂€œIIÙË>9OÏ<Ìcw˝≥˚◊ø√o’oõS◊9î•âY6=∞'É≥µ3RÜU:›8X∞@`D YΩ´Ø—Å	M	N^Ø7k0¢1hÑ±¢kºÍSÁ<ﬁ∑≠ER˘æ.π »<F)©`˚6E∆ÔwLN5<…∆@ÖRê±◊¸Ùqê&±–P°qêOy—!ò‘0é˛l≥™ƒ÷6Ü°\A
÷∫Æ˚_]òÿ[%C≥v1Ø!≠πáFA@òPNﬂ€€YúÒﬂôW∆/.RÓ™Â.óDâ∑.¯›sk∫˜´û”=à˜Œ—x9≥V”◊„2`’î  Ka‰∂[_%éU†Ö!ù-[dﬁIBc∏ÑØÄëb‘LÄp¡‹Åu–vÀ≥® b7õÀ‹∑báÖ¶ªUŒ;å#¨dRö®{’·•…=\û˘kc q|n|ëí√¿“FÜhoBU¡UQÆ{ç7µÒ
@P·JõÍ9e`jâü¿à
…„SÄuŸ2ù≤1≈+Mú›;Pw‡∂[\*+IÉ±HL11œ<Ls~˛xﬁ∏ïUzÓquŒÇ(√\8w‡!Ì8æÁ†~∑w≥Ÿ6ù˛,O∫ì¸§â#aÂ≠Qo1ou’Ú–l∆itUuÜµN¯•L]°ûO’Wi¬˘(œC±Ä Êﬁyù√4äD$Àäáôj÷õ                                                                                                                                                                                                                                                                                                                                                                                                                                                                           if (!usuarioLoginResultDto.Success)
            {
                if (domainLoginResult.Notifications != null && domainLoginResult.Notifications.Any())
                {
                    foreach (var notif in domainLoginResult.Notifications)
                    {
                        Notificar(notif.Tipo, notif.Mensagem, notif.NomeCampo);
                    }
                }
                else if (!ObterNotificacoesParaResposta().Any())
                {
                    Notificar("Erro", "Credenciais inv√°lidas ou erro desconhecido.");
                }
                _logger.LogWarning($"Login falhou para '{email}'.");
            }
            else
            {
                var user = await _identityService.GetUserByEmailAsync(email);
                if (user != null)
                {
                    user.LastLoginDate = DateTime.Now;
                    var updateResult = await _userManager.UpdateAsync(user);
                    if (!updateResult.Succeeded)
                    {
                        _logger.LogError($"Falha ao atualizar LastLoginDate para '{email}'. Erros: {string.Join(", ", updateResult.Errors.Select(e => e.Description))}");
                    }
                }
                Notificar("Sucesso", "Login realizado com sucesso!");
                _logger.LogInformation($"Login bem-sucedido para '{email}'.");
            }
            return usuarioLoginResultDto;
        }

        public async Task<bool> RealizarLogin(string email, string password, bool isPersistent, bool lockoutOnFailure)
        {
            var loginResult = await _identityService.SignInUserAsync(email, password, isPersistent, lockoutOnFailure);
            if (!loginResult)
            {
                if (!ObterNotificacoesParaResposta().Any())
                {
                    Notificar("Erro", "Credenciais inv√°lidas ou conta bloqueada.");
                }
                _logger.LogWarning($"Login falhou para '{email}': Credenciais inv√°lidas ou conta bloqueada.");
            }
            else
            {
                var user = await _identityService.GetUserByEmailAsync(email);
                if (user != null)
                {
                    user.LastLoginDate = DateTime.Now;
                    var updateResult = await _userManager.UpdateAsync(user);
                    if (!updateResult.Succeeded)
                    {
                        _logger.LogError($"Falha ao atualizar LastLoginDate para '{email}'.            –)R  ˝                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             q                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   