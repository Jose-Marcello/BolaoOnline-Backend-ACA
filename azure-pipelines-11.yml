# Pipeline ÚNICA 
#- 1o ESTÁGIO CI - GERAÇÃO DA IMAGEM 
#- 2o ESTÁGIO - Deployment Contínuo (CD) para Azure App Service com Docker.
# Este ESTÁGIO é o segundo passo do processo (CD).
# Ela puxa a imagem recém-construída do ACR e a implanta no App Service.


trigger:
- master # O pipeline completo é disparado a cada push no branch master

pool:
  vmImage: 'ubuntu-latest' 

variables:
  # 1. Variáveis de Conexão e Nomes de Recursos (Você já tinha estas)
  azureSubscription: 'Azure-BolaoOnline-Novo'
  ACR_NAME: 'bolaoonlineregistry'
  APP_SERVICE_NAME: 'bolaoonline_docker'
  RESOURCE_GROUP_NAME: 'ApostasAppRG'
  
  # 2. Variável da Imagem (Padronizamos aqui)
  ACR_IMAGE_NAME: 'bolaoonline-app'
  ACR_IMAGE_TAG: 'latest' # Usamos a tag 'latest' para o deploy

#------------------------------------------------------------------
# Estágio 1: Build e Push da Imagem Docker
#------------------------------------------------------------------
stages:
- stage: BuildAndPush
  displayName: 'Build e Push da Imagem Docker'
  jobs:
  - job: Build
    displayName: 'Construir Imagem'
    steps:
    - task: Docker@2
      displayName: 'Login, Construir e Push da Imagem'
      inputs:
        command: 'buildAndPush'
        repository: '$(ACR_IMAGE_NAME)'
        containerRegistry: 'bolaoonline-docker-registry' # Nome da sua Service Connection
        
        # O contexto de build é a raiz do repositório
        buildContext: '$(Build.SourcesDirectory)' 

        # O caminho do Dockerfile na raiz do repositório
        dockerfile: '$(Build.SourcesDirectory)/Dockerfile' 

        tags: |
          $(Build.BuildId)
          $(ACR_IMAGE_TAG)           
          
#------------------------------------------------------------------
# Estágio 2: Deploy para o Azure App Service
#------------------------------------------------------------------
- stage: DeployToAzure
  displayName: 'Deploy para o Azure App Service'
  dependsOn: BuildAndPush # Este estágio só roda se o BuildAndPush for bem-sucedido
  jobs:
  - job: Deploy
    displayName: 'Deployment do Container'
    steps:
    - task: AzureWebAppContainer@1
      displayName: 'Implantação do Container no App Service'
      inputs:
        azureSubscription: '$(azureSubscription)'
        appName: '$(APP_SERVICE_NAME)'
        resourceGroupName: '$(RESOURCE_GROUP_NAME)'
        
        # Monta o nome completo da imagem
        imageName: '$(ACR_NAME).azurecr.io/$(ACR_IMAGE_NAME):$(ACR_IMAGE_TAG)'
        
        # A API Key/password é gerenciada pela sua Service Connection
        # O Docker Registry de onde o App Service vai puxar a imagem
        # precisa ser configurado no painel do App Service no Azure.
        # Geralmente é feito em 'Container Settings'
