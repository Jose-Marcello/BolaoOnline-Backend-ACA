trigger:
  - main

pool:
  vmImage: 'windows-latest'

variables:
  buildConfiguration: 'Release'
  # Diretório do projeto .NET no agente
  backendProjectDir: '$(Build.SourcesDirectory)/src/ApostasApp.Core.Web'
  # Diretório do projeto Angular no agente
  frontendProjectDir: '$(Build.SourcesDirectory)/src/BolaoOnlineAppV5'
  # Diretório para onde o build do Angular será direcionado
  frontendDistDir: '$(Build.ArtifactStagingDirectory)/frontend-dist'
  # Diretório de publicação do Backend
  backendPublishDir: '$(Build.ArtifactStagingDirectory)/backend-publish'
  # Diretório final que será empacotado para o deploy
  finalDeployDir: '$(Build.ArtifactStagingDirectory)/FinalPackage'
  
stages:
- stage: Build
  displayName: 'Build e Empacotamento do Projeto'
  jobs:
  - job: BuildJob
    displayName: 'Job de Build'
    steps:
    
    # 1. Instala e restaura as dependências do .NET Backend
    - task: DotNetCoreCLI@2
      displayName: 'Restaurar dependências do Backend'
      inputs:
        command: 'restore'
        workingDirectory: '$(backendProjectDir)'
        projects: '**/*.csproj'

    # 2. Publica o .NET Backend
    - task: DotNetCoreCLI@2
      displayName: 'Publicar Backend (.NET)'
      inputs:
        command: 'publish'
        publishWebProjects: false
        projects: '$(backendProjectDir)/ApostasApp.Core.Web.csproj'
        arguments: '--configuration $(buildConfiguration) --output $(backendPublishDir)'
        zipAfterPublish: false
    
    # 3. Instala e compila o Frontend (Angular)
    - script: |
        npm install
        npm run build --prod --output-path=$(frontendDistDir)
      displayName: 'Instalar e compilar Frontend (Angular)'
      workingDirectory: '$(frontendProjectDir)'

    # 4. Mescla o Frontend e o Backend
    - script: |
        echo "Copiando arquivos do Frontend para a wwwroot do Backend..."
        xcopy "$(frontendDistDir)" "$(backendPublishDir)\wwwroot" /s /e /y
      displayName: 'Mesclar Frontend e Backend'
      
    # 5. Compacta a pasta de deploy final em um único arquivo ZIP
    - task: ArchiveFiles@2
      displayName: 'Compactar Artefato Final'
      inputs:
        rootFolderOrFile: '$(backendPublishDir)'
        includeRootFolder: false
        archiveType: 'zip'
        archiveFile: '$(Build.ArtifactStagingDirectory)/BolaoOnline.zip'
        replaceExistingArchive: true

    # 6. Publica o único artefato de build (o arquivo ZIP)
    - task: PublishBuildArtifacts@1
      displayName: 'Publicar o Artefato de Build'
      inputs:
        PathtoPublish: '$(Build.ArtifactStagingDirectory)/BolaoOnline.zip'
        ArtifactName: 'drop'

- stage: Deploy
  displayName: 'Deploy para Azure'
  dependsOn: Build
  jobs:
  - deployment: DeployJob
    displayName: 'Job de Deployment'
    environment: 'AmbienteDeTestes'
    strategy:
      runOnce:
        deploy:
          steps:
            - task: AzureWebApp@1
              displayName: 'Implantar no Azure App Service'
              inputs:
                azureSubscription: 'Azure-BolaoOnline-Novo'
                appName: 'bolaoonline-testes'
                package: '$(Pipeline.Workspace)/drop/BolaoOnline.zip'