trigger:
  - main

pool:
  vmImage: 'windows-latest'

variables:
  buildConfiguration: 'Release'
  appPublishDir: '$(Build.ArtifactStagingDirectory)/app'
  frontendProjectDir: '$(Build.SourcesDirectory)/src/BolaoOnlineAppV5'
  frontendDistDir: '$(Build.SourcesDirectory)/src/BolaoOnlineAppV5/dist/bolao-online-app-v5'
  backendProjectDir: '$(Build.SourcesDirectory)/src/ApostasApp.Core.Web'
  # Diretório para o pacote final para garantir a estrutura correta
  finalPackageDir: '$(Build.ArtifactStagingDirectory)/FinalPackage'

stages:
- stage: Build
  displayName: 'Build e Empacotamento do Aplicativo'
  jobs:
  - job: BuildJob
    displayName: 'Job de Build'
    steps:
      # 1. Garante que a versão correta do Node.js está instalada
      - task: NodeTool@0
        displayName: 'Instalar Node.js'
        inputs:
          versionSpec: '18.x'

      # 2. Instala as dependências do Frontend (Angular)
      - script: npm install
        displayName: 'Instalar dependências do Frontend'
        workingDirectory: '$(frontendProjectDir)'

      # 3. Compila o Frontend (Angular)
      - script: npm run build --configuration=$(buildConfiguration) --verbose
        displayName: 'Compilar Frontend (Angular)'
        workingDirectory: '$(frontendProjectDir)'

      # 4. Diagnosticar a saída do build para confirmar o caminho da pasta dist
      - script: |
          echo "Listando o conteúdo da pasta do projeto Angular..."
          dir /s "$(frontendProjectDir)"
        displayName: 'Diagnosticar - Onde está a pasta dist?'

      # 5. Publica o backend do .NET
      - task: DotNetCoreCLI@2
        displayName: 'Publicar Backend (.NET)'
        inputs:
          command: 'publish'
          projects: '$(backendProjectDir)/ApostasApp.Core.Web.csproj'
          arguments: '--configuration $(buildConfiguration) --output $(finalPackageDir)'
          zipAfterPublish: false
      
      # 6. Copia os arquivos compilados do Angular para a wwwroot do .NET
      - task: CopyFiles@2
        displayName: 'Copiar arquivos do Frontend para a wwwroot'
        inputs:
          SourceFolder: '$(frontendDistDir)'
          Contents: '**'
          TargetFolder: '$(finalPackageDir)/wwwroot'
          cleanTargetFolder: true

      # 7. Adiciona um arquivo de texto com a versão do build
      - script: |
          echo "Criando arquivo de versão..."
          echo "Versao do Build: $(Build.BuildId)" > "$(finalPackageDir)/build.version.txt"
          echo "Origem do Commit: $(Build.SourceVersion)" >> "$(finalPackageDir)/build.version.txt"
        displayName: 'Adicionar arquivo de Versão do Build'

      # 8. Compacta a pasta de DEPLOY final em um único arquivo ZIP
      - task: ArchiveFiles@2
        displayName: 'Compactar Artefato Final'
        inputs:
          rootFolderOrFile: '$(finalPackageDir)'
          includeRootFolder: false
          archiveType: 'zip'
          archiveFile: '$(Build.ArtifactStagingDirectory)/BolaoOnline.zip'
          replaceExistingArchive: true

      # 9. Publica o único artefato de build (o arquivo ZIP)
      - task: PublishBuildArtifacts@1
        displayName: 'Publicar o Artefato de Build'
        inputs:
          PathtoPublish: '$(Build.ArtifactStagingDirectory)/BolaoOnline.zip'
          ArtifactName: 'drop'

- stage: Deploy
  displayName: 'Deploy para Azure'
  dependsOn: Build
  jobs:
    - deployment: DeployJob
      displayName: 'Job de Deployment'
      environment: 'AmbienteDeTestes'
      strategy:
        runOnce:
          deploy:
            steps:
              - task: AzureWebApp@1
                displayName: 'Implantar no Azure App Service'
                inputs:
                  azureSubscription: 'Azure-BolaoOnline-Novo'
                  appName: 'bolaoonline-testes'
                  package: '$(Pipeline.Workspace)/drop/BolaoOnline.zip'
                  # Esta é a linha que vai garantir a limpeza do deploy anterior.
                  # Ele remove arquivos que não estão no pacote do deploy.
                  RemoveAdditionalFilesFromFolders: true
                  enable_msdeploy_web_rule: true