trigger:
- master
 
pool:
  vmImage: 'windows-latest'
 
variables:
  buildConfiguration: 'production'
  frontendProjectDir: '$(Build.SourcesDirectory)/src/ApostasApp.Core.Web/BolaoOnlineAppV5'
  backendProjectDir: '$(Build.SourcesDirectory)/src/ApostasApp.Core.Web'
  # A pasta de publicação final do backend
  appPublishDir: '$(Build.ArtifactStagingDirectory)/AppPublish'
  zipName: 'bolao-app-$(Build.BuildId).zip'
  zipPath: '$(Build.ArtifactStagingDirectory)/$(zipName)'
  # A pasta de mesclagem de arquivos do front-end e back-end
  finalPublishDir: '$(Build.ArtifactStagingDirectory)/FinalPublish'

stages:
- stage: Build
  displayName: 'Build e Empacotamento do Aplicativo'
  jobs:
  - job: BuildJob
    displayName: 'Job de Build'
    steps:
      - task: NodeTool@0
        displayName: 'Instalar Node.js'
        inputs:
          versionSpec: '18.x'
 
      - task: Npm@1
        displayName: 'npm install do frontend'
        inputs:
          command: 'install'
          workingDir: '$(frontendProjectDir)'
 
      - task: Npm@1
        displayName: 'npm build do frontend'
        inputs:
          command: 'custom'
          customCommand: 'run build:prod'
          workingDir: '$(frontendProjectDir)'
      
      - task: DotNetCoreCLI@2
        displayName: 'Publicar Backend'
        inputs:
          command: 'publish'
          publishWebProjects: false
          projects: '$(backendProjectDir)/ApostasApp.Core.Web.csproj'
          arguments: '-c $(buildConfiguration) --output "$(appPublishDir)" --runtime win-x64 --self-contained true'
          zipAfterPublish: false
      
      - task: CopyFiles@2
        displayName: 'Copiar Conteúdo do Backend para a pasta final de deploy'
        inputs:
          SourceFolder: '$(appPublishDir)/ApostasApp.Core.Web'
          Contents: |
            **
            !BolaoOnlineAppV5/**
          TargetFolder: '$(finalPublishDir)'
          cleanTargetFolder: true
      
      - task: CopyFiles@2
        displayName: 'Copiar arquivos do Frontend para pasta final wwwroot'
        inputs:
          SourceFolder: '$(frontendProjectDir)/dist/bolao-online-app-v5/browser'
          Contents: '**'
          TargetFolder: '$(finalPublishDir)/wwwroot'
          cleanTargetFolder: true
      
      - task: CopyFiles@2
        displayName: 'Copiar arquivos estáticos do backend para wwwroot'
        inputs:
          SourceFolder: '$(backendProjectDir)/wwwroot'
          Contents: '**'
          TargetFolder: '$(finalPublishDir)/wwwroot'
          cleanTargetFolder: false
      
      # REMOVER TAREFAS DE REMOÇÃO DE PASTA
      # task: PowerShell@2
      #   displayName: 'Remover pasta de projeto frontend'
      #   inputs:
      #     targetType: 'inline'
      #     script: |
      #       Remove-Item -Path "$(finalPublishDir)/BolaoOnlineAppV5" -Recurse -Force
      # ...
      
      - task: ArchiveFiles@2
        displayName: 'Compactar o Artefato para Deploy'
        inputs:
          rootFolderOrFile: '$(finalPublishDir)'
          archiveType: 'zip'
          archiveFile: '$(zipPath)'
          replaceExistingArchive: true
          includeRootFolder: false
 
      - task: PublishBuildArtifacts@1
        displayName: 'Publicar o Artefato de Build'
        inputs:
          PathtoPublish: '$(zipPath)'
          ArtifactName: 'drop'
 
- stage: Deploy
  displayName: 'Deploy para Azure'
  dependsOn: Build
  jobs:
    - deployment: DeployJob
      displayName: 'Job de Deployment'
      environment: 'AmbienteDeTestes'
      strategy:
        runOnce:
          deploy:
            steps:
              - task: AzureWebApp@1
                displayName: 'Implantar no Azure App Service'
                inputs:
                  azureSubscription: 'Azure-BolaoOnline-Novo'
                  appType: 'webApp'
                  appName: 'bolaoonline-testes4'
                  package: '$(Pipeline.Workspace)/drop/$(zipName)'
                  removeAdditionalFilesFromFolders: true