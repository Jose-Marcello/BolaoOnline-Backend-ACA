trigger:
- main

pool:
  name: MyAgentPool

variables:
  - group: BolaoOnline-ProdSecrets
  - name: dockerRegistryServiceConnection
    value: 'bolaoonline-docker-registry'
  - name: imageName
    value: 'bolaoonline-app'

stages:
- stage: BuildAndPush
  displayName: 'Build and Push Docker Image'
  jobs:
  - job: BuildDocker
    displayName: 'Build and Push'
    steps:
    # Adicione esta linha para garantir que o c√≥digo seja baixado
    - checkout: self
    - task: Docker@2
      inputs:
        containerRegistry: '$(dockerRegistryServiceConnection)'
        repository: '$(imageName)'
        command: 'buildAndPush'
        Dockerfile: 'Dockerfile'
        tags: |
          $(Build.BuildId)
          latest

- stage: Deploy
  displayName: 'Deploy to Test Environment'
  jobs:
  - deployment: DeployJob
    displayName: 'Deploy Job'
    environment: AmbienteDeTestes
    pool:
      name: MyAgentPool
    strategy:
      runOnce:
        deploy:
          steps:
          - task: AzureWebApp@1
            displayName: 'Deploy Azure Web App'
            inputs:
              azureSubscription: 'Azure-BolaoOnline-Novo'
              appType: 'webAppContainer'
              appName: 'bolaoonline-testes'
              dockerNamespace: 'bolaoonlineregistry.azurecr.io'
              dockerRepository: '$(imageName)'
              dockerImageTag: '$(Build.BuildId)'